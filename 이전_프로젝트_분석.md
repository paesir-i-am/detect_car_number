# detect_car_number 프로젝트 분석 및 실행 가이드

## 프로젝트 개요
- 차량 번호판 탐지와 OCR을 합친 단일 Flask 애플리케이션이다 (`app.py`).
- YOLOv5(커스텀 가중치 `yo5s_b32_e10.pt`)로 번호판을 검출하고(`model_detect.py`), 잘라낸 영역을 Tesseract OCR로 문자 인식한다(`ocr.py`).
- 추론 결과로 가장 많이 등장한 번호판 문자열을 반환하며, 대응하는 프레임 이미지를 `model/result_img/<번호>.jpg`로 복사한다.

## 주요 구성 요소
- `app.py`: Flask 앱과 단일 엔드포인트 `/v1/live/customer-car` 정의. 요청이 들어오면 `model_analysis()`를 실행해 YOLO 탐지 → OCR → 번호판 문자열을 반환.
- `model_detect.py`: YOLOv5 추론 래퍼. `model_init.py`에서 미리 로드한 모델을 사용해 이미지/영상에서 탐지 및 Crop 저장.
- `model_init.py`: `yolov5.models.common.DetectMultiBackend`로 가중치(`model/yo5s_b32_e10.pt`)를 로드하고 디바이스를 선택.
- `ocr.py`: 번호판 Crop 이미지에서 문자 영역을 찾고 Tesseract(`model/tesseract-ocr-w64-setup-v4.0.0.20181030/tesseract.exe`)로 OCR 수행.
- `myfunc.py`: 보조 유틸(디렉터리 생성, 좌표 변환, Crop 저장, 파일 리스트 추출 등).
- 리소스
  - `custom.yaml`: YOLOv5 데이터셋 클래스 정의(0: plate).
  - `yo5s_b32_e10.pt`: 커스텀 학습 가중치.
  - `gate_60f_01_day.MOV`: 샘플 입력 영상.
  - `yolov5/`: Ultralytics YOLOv5 소스 전체 포함(추론에 사용).
  - `tesseract-ocr-w64-setup-v4.0.0.20181030/`: Windows용 Tesseract 배포본(OCR 엔진).

## 동작 흐름 (요청 → 응답)
1) `/v1/live/customer-car` 호출  
   - 현재는 GET이며, 요청 바디는 사용하지 않고 `model_analysis('video')`를 바로 실행한다(`app.py`).

2) `model_analysis()` (`app.py`)  
   - `root_dir = 'model'`로 고정. 내부에서 사용할 경로를 모두 `model/` 하위로 기대한다(예: 가중치, 데이터 YAML, 입력 영상, 결과 디렉터리).  
   - YOLO 추론 실행:  
     - `run()` 호출(`model_detect.py`) with `weights=model/yo5s_b32_e10.pt`, `source=model/gate_60f_01_day.MOV`, `data=model/custom.yaml`, `save_txt=True`, `save_conf=True`, `save_crop=True`, `project=model/result_save`.  
     - 실행 전에 `model/result_save/exp` 디렉터리가 있으면 삭제.  
   - YOLO 결과 활용:  
     - Crop 이미지는 `model/result_save/exp/crops/plate/*.jpg`에 저장된다.  
     - 동일 프레임 전체 이미지는 `model/result_save/exp/images/*.jpg`에 저장된다(탐지된 프레임만 최대 30장).
   - OCR 처리 및 최종 선택:  
     - 모든 Crop에 대해 `ocr.tesseract_ocr()` 호출.  
     - 문자열 길이가 7자 이상인 것만 유효로 간주하고, 등장 빈도가 가장 높은 번호판을 최종 결과로 선택.  
     - 해당 번호판이 찍힌 전체 이미지를 `model/result_img/<car_num>.jpg`로 복사.  
   - API 응답: `{"car_number": "<결과 문자열>"}`.

3) YOLO 추론 내부 (`model_detect.py`)  
   - `model_init.py`에서 전역으로 로드된 모델을 그대로 사용(매 요청마다 재로딩하지 않음).  
   - `save_crop=True`일 때 `exp/crops/plate/<원본명>_<frame>_<conf>.jpg`로 Crop 저장.  
   - 영상 처리 시 탐지된 프레임만 최대 30장까지 저장 후 루프 종료.  
   - `FLG_SAVE=False`로 설정되어 있어 텍스트 라벨(`labels/*.txt`)과 원본 저장은 기본 비활성화지만, 영상 처리 시 `images/`에는 여전히 탐지된 프레임이 저장되도록 커스텀되어 있음.

4) OCR 파이프라인 (`ocr.py`)  
   - OpenCV로 전처리(그레이스케일 → 블러 → 적응형 Threshold → 컨투어 필터링).  
   - 문자 후보를 기하학적으로 그룹핑한 뒤, 번호판 영역을 회전·Crop.  
   - Tesseract 실행 경로를 `model/tesseract-ocr-w64-setup-v4.0.0.20181030/tesseract.exe`로 고정 후 `lang='kor'`, `--psm 7 --oem 0` 설정으로 인식.  
   - 한글/숫자만 남겨서 반환.

## 실행 준비 (uv 기반, 로컬 기준)
- Python: 3.9+ 권장.
- 필수 시스템 의존성
  - PyTorch: `pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu` (GPU 환경이면 cuda 버전 선택).
  - OpenCV, NumPy, Pillow, PyYAML, tqdm, requests, pandas, matplotlib, seaborn 등 YOLOv5 의존성.
  - Tesseract OCR 엔진:  
    - Windows: `model/`의 `tesseract-ocr-w64-setup-v4.0.0.20181030/`를 그대로 쓰거나 시스템 설치 후 실행 경로를 반영.  
    - macOS: `brew install tesseract` 후 실행 경로(`/opt/homebrew/bin/tesseract` 또는 `/usr/local/bin/tesseract`)를 `ocr.py`나 환경변수에 지정.  
    - Linux: `sudo apt-get install tesseract-ocr` 등 배포판 패키지 사용 후 바이너리 경로(`/usr/bin/tesseract`)를 지정.
- uv로 가상환경 생성 및 패키지 설치
  ```bash
  uv venv --python 3.9
  source .venv/bin/activate           # Windows: .venv\Scripts\activate
  uv pip install -r requirements.txt
  uv pip install -r yolov5/requirements.txt
  # 필요 시 torch/torchvision/torchaudio는 별도로 설치 (cuda/cpu 선택)
  uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
  uv pip install opencv-python pytesseract pillow numpy
  ```

## 실행 방법 (Flask)
1. uv 가상환경 활성화  
   ```bash
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   ```
2. 리소스 배치  
   - 코드가 `root_dir = 'model'`을 사용하므로 아래 파일/폴더를 `model/` 아래에 배치하거나, 경로를 코드에서 변경해야 한다.  
     - `yo5s_b32_e10.pt`, `custom.yaml`, `gate_60f_01_day.MOV`, `tesseract-ocr-w64-setup-v4.0.0.20181030/`, `yolov5/`(또는 `model_init.py`, `model_detect.py`, `ocr.py`, `myfunc.py` 등).  
   - 현 저장소에는 루트에 위치하므로 그대로 실행하려면 `root_dir`를 `'.'`로 수정하거나 파일을 `model/` 디렉터리로 이동해야 한다.
3. 환경변수 설정(선택)  
   ```bash
   export FLASK_ENV=development
   export FLASK_APP=app.py  # 파일명이 app.py라면 생략 가능
   ```
4. 서버 실행  
   ```bash
   flask --app app run  # 또는 python app.py
   ```
5. 테스트 호출  
   - 브라우저 혹은 HTTP 클라이언트로 `GET http://127.0.0.1:5000/v1/live/customer-car` 호출.  
   - 응답 예시: `{"car_number": "12가3456"}`. 결과 이미지는 `model/result_img/`에 저장.

## 파일별 상세 역할 및 주요 코드 포인트
- `app.py`
  - Flask 앱 생성, CORS 허용, `/` 헬스체크, `/v1/live/customer-car` 엔드포인트 제공.
  - `model_analysis()`에서 경로/입력/출력을 모두 하드코딩(`root_dir='model'`, `source=gate_60f_01_day.MOV`). 결과 선택 로직: OCR 결과 중 길이 ≥ 7인 것만 카운트 후 최빈값 반환.
  - 한계: 요청 바디 미사용, 에러 처리 없음(`plate_cnt`가 비면 IndexError).
- `model_init.py`
  - 애플리케이션 시작 시 1회 YOLOv5 모델 로드(`DetectMultiBackend`).  
  - `weights='model/yo5s_b32_e10.pt'`, `data='model/custom.yaml'`, `device=select_device('')`로 GPU/CPU 자동 선택.  
  - 개선: 경로를 환경변수/설정으로 외부화, 로딩 실패 예외 처리.
- `model_detect.py`
  - `run()`은 YOLOv5 추론을 감싼 함수. `model_init`의 `model`을 전역 참조하여 재로딩 방지.
  - 커스텀 포인트: `save_dir/images` 강제 생성, 탐지된 프레임을 최대 30장까지만 저장, `save_crop=True`일 때 Crop 파일명에 프레임·conf 포함.
  - `FLG_SAVE=False`로 텍스트/원본 저장 비활성화지만, `images/` 저장은 별도로 수행.
- `ocr.py`
  - OpenCV 전처리 후 번호판 후보 컨투어를 기하학적으로 필터링·정렬해 Crop.  
  - `pytesseract.pytesseract.tesseract_cmd`를 Windows용 경로로 고정. `lang='kor'`, `--psm 7 --oem 0` 설정.  
  - 전역 리스트 `possible_contours`가 누적될 수 있어 함수 재호출 시 초기화 필요.
  - 플랫폼 대응 필요: 환경변수/설정 기반으로 실행 경로를 읽게 바꾸는 것이 안전.
- `myfunc.py`
  - 디렉터리 생성, YOLO 좌표 → 절대 좌표 변환, 이미지 Crop, 파일 리스트 수집.  
  - `yolo_txt2xml_coordinate()`는 YOLO txt 형식(xywh, 상대 좌표)을 절대 좌표로 변환.  
  - 예외 처리 최소화되어 있어 입력 검증 추가 필요.
- `custom.yaml`
  - 클래스 정의(0: plate)와 데이터 경로. 현재 `path: /content/data`로 되어 있어 재학습 시 경로 수정 필요.
- `yo5s_b32_e10.pt`
  - 커스텀 학습된 번호판 검출 가중치. 입력 영상과 함께 추론할 때 필수.
- `tesseract-ocr-w64-setup-v4.0.0.20181030/`
  - Windows용 Tesseract 번들. macOS/Linux에서는 이 바이너리를 사용할 수 없음.

## Tesseract 플랫폼 대응 및 코드 수정 제안
- macOS/Linux에서 해야 할 일
  1) 시스템 패키지로 Tesseract 설치  
     - macOS: `brew install tesseract`  
     - Ubuntu/Debian: `sudo apt-get install tesseract-ocr`  
  2) 실행 경로 확인  
     - macOS: `/opt/homebrew/bin/tesseract` 또는 `/usr/local/bin/tesseract`  
     - Linux: `/usr/bin/tesseract`
  3) 코드에서 실행 경로를 설정하도록 수정  
     - 환경변수 `TESSERACT_CMD`가 있으면 우선 사용하고, 없으면 플랫폼별 기본 경로를 사용. Windows 번들은 마지막 fallback으로 둔다.

- `ocr.py` 수정 예시(핵심 로직)
  ```python
  import os
  import platform
  ...
  def _default_tesseract_cmd():
      env_path = os.getenv("TESSERACT_CMD")
      if env_path:
          return env_path
      system = platform.system()
      if system == "Darwin":
          return "/opt/homebrew/bin/tesseract"  # 필요 시 /usr/local/bin/tesseract
      if system == "Linux":
          return "/usr/bin/tesseract"
      # Windows fallback: 번들된 실행파일
      return "model/tesseract-ocr-w64-setup-v4.0.0.20181030/tesseract.exe"

  def tesseract_ocr(img_path):
      ...
      pytesseract.pytesseract.tesseract_cmd = _default_tesseract_cmd()
      chars = pytesseract.image_to_string(img_result, lang="kor", config="--psm 7 --oem 0")
      ...
  ```
  - 이렇게 하면 OS에 따라 자동으로 경로를 잡거나, `TESSERACT_CMD` 환경변수로 명시 지정할 수 있어 크로스플랫폼 문제가 해결된다.

## 현재 코드의 한계/리스크
- 하드코딩 경로: `root_dir='model'`, 입력 소스 `gate_60f_01_day.MOV`, 가중치 파일명 등이 모두 고정되어 있어 외부 입력을 받을 수 없다.
- 플랫폼 의존성: 포함된 Tesseract 실행파일은 Windows용이라 macOS/Linux에서는 동작하지 않는다(경로 수정 및 별도 설치 필요).
- 불완전한 의존성 명세: `requirements.txt`에 YOLO, PyTorch, OCR 관련 패키지가 빠져 있어 새 환경에서는 설치 누락 가능성이 높다.
- 에러 처리 부재: 탐지가 없거나 OCR 결과가 7자 미만일 경우 `plate_cnt`가 비어 IndexError가 발생할 수 있다. 요청 파라미터 검증도 없다.
- 성능/지연: 요청마다 전체 영상(최대 30 프레임)을 CPU로 추론하므로 응답 지연이 크다. 배치 처리나 비동기 처리가 필요할 수 있다.
- 전역 상태: `ocr.py`의 `possible_contours`가 전역 리스트로 누적되어 재호출 시 오염 가능성이 있고, 모델 로딩 실패 시 예외 처리 없다.

## FastAPI 전환 및 스프링 연동 방향 제안
1. 서비스 계층 분리  
   - `model_analysis()`를 입력/출력 명확한 함수(`detect_video(source_path) -> {car_number, images...}`)로 분리하고, 모델 로딩을 애플리케이션 시작 시 1회 수행하도록 리팩터링.
2. FastAPI 엔드포인트 설계  
   - `POST /v1/live/customer-car` 형태로 영상/이미지 파일 업로드 또는 URL을 입력받도록 변경.  
   - 응답 스키마(Pydantic)로 번호판 문자열, 신뢰도, 저장 경로 등을 반환.  
   - 비동기 파일 수신 + 동기 추론을 조합하고, 백그라운드 작업 큐(예: Celery, RQ) 고려.
3. 설정/경로 관리  
   - `pydantic-settings` 또는 `.env`로 모델 경로, 결과 저장 경로, Tesseract 바이너리 경로를 외부 설정화.  
   - macOS/Linux Tesseract 경로 지원을 위해 `ocr.py`에서 환경변수 우선으로 읽도록 수정.
4. 예외 처리 및 검증  
   - 탐지/인식 실패 시 명확한 에러 코드와 메시지를 반환하고, 빈 결과를 처리하도록 로직 보강.
5. 스프링부트 연동  
   - 스프링 서비스에서 FastAPI 엔드포인트를 HTTP로 호출하거나, gRPC/메시지 큐를 통한 비동기 연동을 검토.  
   - 응답에 이미지 저장 위치를 포함하거나, S3 등 오브젝트 스토리지에 업로드 후 URL만 전달하는 방식으로 교환.
6. 성능 최적화  
   - GPU 서버에서는 CUDA 버전 PyTorch로 설치하고, 배치 크기/프레임 샘플링 최적화.  
   - 번호판 Crop이 여러 장일 때 OCR을 병렬 처리하거나, 한국 번호판 전용 경량 OCR 모델(예: CRNN)로 교체를 검토.